---
import SiteLayout from '../layouts/SiteLayout.astro';
import { Protect } from "@clerk/astro/components";
---

<SiteLayout title="Preview Your Bio - Blahaj.bio">
  <Protect>
    <div class="py-16">
      <div class="max-w-4xl mx-auto px-4">
        
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-github-fg-default mb-4">
            Bio Preview
          </h1>
          <p class="text-gray-600 dark:text-github-fg-muted mb-6">
            This is how your bio appears to visitors
          </p>
          <div class="flex gap-4 justify-center">
            <a
              href="/dashboard"
              class="bg-github-accent-emphasis hover:bg-github-accent-fg text-white font-semibold py-2 px-4 rounded-lg transition-colors"
            >
              ‚Üê Back to Dashboard
            </a>
            <button
              id="shareBtn"
              class="bg-github-success-emphasis hover:bg-github-success-fg text-white font-semibold py-2 px-4 rounded-lg transition-colors"
            >
              Share Profile
            </button>
          </div>
        </div>

        <!-- Bio Preview Container -->
        <div class="max-w-2xl mx-auto">
          <div id="bioPreview" class="bg-white dark:bg-github-canvas-overlay rounded-2xl shadow-xl p-8 border border-gray-200 dark:border-github-border-default">
            <!-- Content will be populated by JavaScript -->
            <div class="text-center text-gray-500 dark:text-github-fg-muted">
              Loading your bio...
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Wait for Clerk to load (it's automatically initialized by @clerk/astro)
      const waitForClerk = (): Promise<any> => {
        return new Promise((resolve) => {
          if (window.Clerk && window.Clerk.user) {
            resolve(window.Clerk);
          } else {
            setTimeout(() => resolve(waitForClerk()), 100);
          }
        });
      };

      const clerk = await waitForClerk();
      const user = clerk.user;
      if (user) {
        loadBioPreview(user.username);
      }

      function loadBioPreview(username) {
        try {
          const savedBio = localStorage.getItem(`bio_${username}`);
          const bioPreviewDiv = document.getElementById('bioPreview');
          
          if (savedBio) {
            const bioData = JSON.parse(savedBio);
            
            bioPreviewDiv.innerHTML = `
              <div class="text-center mb-8">
                <img 
                  src="${bioData.profile_image || user.imageUrl}" 
                  alt="Profile" 
                  class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-github-border-default"
                >
                <h1 class="text-3xl font-bold text-gray-900 dark:text-github-fg-default">
                  ${bioData.display_name || bioData.full_name || user.fullName}
                </h1>
                ${bioData.pronouns ? `<p class="text-gray-500 dark:text-github-fg-muted mt-2">${bioData.pronouns}</p>` : ''}
                <p class="text-sm text-gray-600 dark:text-github-fg-subtle mt-1">@${username}</p>
              </div>
              
              ${bioData.bio ? `
                <div class="prose max-w-none mb-8 text-gray-700 dark:text-github-fg-default">
                  <p class="whitespace-pre-wrap text-center">${bioData.bio}</p>
                </div>
              ` : ''}
              
              ${bioData.links ? `
                <div class="space-y-3">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-github-fg-default text-center mb-4">Links</h3>
                  ${bioData.links.split('\n').filter(link => link.trim()).map(link => {
                    const trimmedLink = link.trim();
                    const displayText = trimmedLink.replace(/^https?:\/\//, '').replace(/\/$/, '');
                    return `
                      <a
                        href="${trimmedLink.startsWith('http') ? trimmedLink : 'https://' + trimmedLink}"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="block w-full text-center py-3 px-4 rounded-lg bg-github-accent-emphasis hover:bg-github-accent-fg text-white transition-colors"
                      >
                        ${displayText}
                      </a>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            `;
          } else {
            bioPreviewDiv.innerHTML = `
              <div class="text-center">
                <img 
                  src="${user.imageUrl}" 
                  alt="Profile" 
                  class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-github-border-default"
                >
                <h1 class="text-3xl font-bold text-gray-900 dark:text-github-fg-default mb-4">
                  ${user.fullName || user.username}
                </h1>
                <p class="text-sm text-gray-600 dark:text-github-fg-subtle mb-6">@${username}</p>
                <div class="text-gray-500 dark:text-github-fg-muted">
                  <p class="mb-4">No bio created yet.</p>
                  <a 
                    href="/dashboard" 
                    class="inline-block bg-github-success-emphasis hover:bg-github-success-fg text-white font-semibold py-2 px-4 rounded-lg transition-colors"
                  >
                    Create Your Bio
                  </a>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading bio preview:', error);
          document.getElementById('bioPreview').innerHTML = `
            <div class="text-center text-red-500">
              Error loading bio preview. Please try again.
            </div>
          `;
        }
      }

      // Share functionality
      document.getElementById('shareBtn').addEventListener('click', () => {
        if (user) {
          const profileUrl = `${window.location.origin}/@${user.username}`;
          if (navigator.share) {
            navigator.share({
              title: `${user.fullName}'s Bio`,
              text: 'Check out my bio page on Blahaj.bio',
              url: profileUrl
            });
          } else {
            navigator.clipboard.writeText(profileUrl).then(() => {
              // Show success feedback
              const btn = document.getElementById('shareBtn');
              const originalText = btn.textContent;
              btn.textContent = 'Link Copied!';
              setTimeout(() => {
                btn.textContent = originalText;
              }, 2000);
            });
          }
        }
      });
    </script>
  </Protect>
</SiteLayout>
