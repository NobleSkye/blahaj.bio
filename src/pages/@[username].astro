---
import SiteLayout from '../layouts/SiteLayout.astro';

const { username } = Astro.params;
---
  return [];
}

const { username } = Astro.params;

// This will be handled client-side for now
---

<SiteLayout title={`@${username} - Blahaj.bio`}>
  <div class="py-16">
    <div class="max-w-2xl mx-auto px-4">
      <div id="bioContainer" class="bg-white dark:bg-github-canvas-overlay rounded-2xl shadow-xl p-8 border border-gray-200 dark:border-github-border-default">
        <!-- Content will be populated by JavaScript -->
        <div class="text-center">
          <div class="animate-pulse">
            <div class="w-24 h-24 bg-gray-300 dark:bg-github-canvas-subtle rounded-full mx-auto mb-4"></div>
            <div class="h-8 bg-gray-300 dark:bg-github-canvas-subtle rounded w-48 mx-auto mb-2"></div>
            <div class="h-4 bg-gray-300 dark:bg-github-canvas-subtle rounded w-32 mx-auto"></div>
          </div>
          <p class="text-gray-600 dark:text-github-fg-muted mt-4">Loading profile...</p>
        </div>
      </div>

      <!-- Not Found / Error State -->
      <div id="notFoundContainer" class="hidden bg-white dark:bg-github-canvas-overlay rounded-2xl shadow-xl p-8 border border-gray-200 dark:border-github-border-default text-center">
        <div class="mb-6">
          <div class="w-24 h-24 bg-gray-200 dark:bg-github-canvas-subtle rounded-full mx-auto mb-4 flex items-center justify-center">
            <span class="text-4xl">ðŸ¤”</span>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-github-fg-default mb-2">
            Profile Not Found
          </h1>
          <p class="text-gray-600 dark:text-github-fg-muted mb-6">
            The user @{username} hasn't created a bio yet, or the username doesn't exist.
          </p>
        </div>
        
        <div class="space-y-4">
          <a
            href="/"
            class="inline-block bg-github-accent-emphasis hover:bg-github-accent-fg text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            Go Home
          </a>
          <div class="text-sm text-gray-500 dark:text-github-fg-subtle">
            Want to create your own bio? <a href="/dashboard" class="text-github-accent-emphasis hover:text-github-accent-fg">Sign up here</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ username }}>
    // Helper function to generate links HTML
    function generateLinksHTML(links) {
      if (!links) return '';
      
      const linkArray = links.split('\n').filter(link => link.trim());
      if (linkArray.length === 0) return '';
      
      let html = '<div class="space-y-3"><h3 class="text-lg font-semibold text-gray-900 dark:text-github-fg-default text-center mb-4">Links</h3>';
      
      linkArray.forEach(link => {
        const trimmedLink = link.trim();
        const displayText = trimmedLink.replace(/^https?:\/\//, '').replace(/\/$/, '');
        const fullLink = trimmedLink.startsWith('http') ? trimmedLink : 'https://' + trimmedLink;
        
        html += `
          <a
            href="${fullLink}"
            target="_blank"
            rel="noopener noreferrer"
            class="block w-full text-center py-3 px-4 rounded-lg bg-github-accent-emphasis hover:bg-github-accent-fg text-white transition-colors"
          >
            ${displayText}
          </a>
        `;
      });
      
      html += '</div>';
      return html;
    }

    // Load bio data for the specified username
    function loadUserBio(username) {
      try {
        const savedBio = localStorage.getItem(`bio_${username}`);
        const bioContainer = document.getElementById('bioContainer');
        const notFoundContainer = document.getElementById('notFoundContainer');
        
        if (savedBio) {
          const bioData = JSON.parse(savedBio);
          
          bioContainer.innerHTML = `
            <div class="text-center mb-8">
              <img 
                src="${bioData.profile_image || '/default-avatar.svg'}" 
                alt="Profile picture of ${bioData.display_name || bioData.username}"
                class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-github-border-default"
                onerror="this.src='/default-avatar.svg'"
              >
              <h1 class="text-3xl font-bold text-gray-900 dark:text-github-fg-default">
                ${bioData.display_name || bioData.full_name || username}
              </h1>
              ${bioData.pronouns ? '<p class="text-gray-500 dark:text-github-fg-muted mt-2">' + bioData.pronouns + '</p>' : ''}
              <p class="text-sm text-gray-600 dark:text-github-fg-subtle mt-1">@${username}</p>
            </div>
            
            ${bioData.bio ? '<div class="prose max-w-none mb-8 text-gray-700 dark:text-github-fg-default"><p class="whitespace-pre-wrap text-center">' + bioData.bio + '</p></div>' : ''}
            
            ${bioData.links ? generateLinksHTML(bioData.links) : ''}
            
            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-github-border-default text-center">
              <p class="text-sm text-gray-500 dark:text-github-fg-subtle">
                Powered by <a href="/" class="text-github-accent-emphasis hover:text-github-accent-fg">Blahaj.bio</a>
              </p>
            </div>
          `;
        } else {
          // Show not found state
          bioContainer.classList.add('hidden');
          notFoundContainer.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading bio:', error);
        // Show error state
        document.getElementById('bioContainer').innerHTML = `
          <div class="text-center text-red-500">
            <p>Error loading profile. Please try again later.</p>
          </div>
        `;
      }
    }

    // Load the bio when page loads
    loadUserBio(username);

    // Update page title
    document.title = `@${username} - Blahaj.bio`;
  </script>
</SiteLayout>
