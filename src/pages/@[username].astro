---
import Layout from '../layouts/Layout.astro';

const { username } = Astro.params;

if (!username) {
  return Astro.redirect('/404');
}

// Try to get bio data from localStorage first (for immediate preview)
// In a real app, you'd fetch from Convex API here
let bio = null;

// For now, we'll create a simple API call to get bio data
// This would be replaced with proper Convex API call in production
const CONVEX_URL = import.meta.env.PUBLIC_CONVEX_URL;

if (CONVEX_URL) {
  try {
    const response = await fetch(`${CONVEX_URL}/api/query`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        path: 'bios:getBio',
        args: { username: username.toLowerCase() },
      }),
    });

    if (response.ok) {
      const result = await response.json();
      bio = result.value;
    }
  } catch (error) {
    console.error('Error fetching bio:', error);
  }
}

// If no bio found, show 404
if (!bio) {
  return Astro.redirect('/404');
}
---

<<<<<<< Updated upstream
<Layout title={`${bio.display_name} - Blahaj.bio`}>
  <div class="min-h-screen flex flex-col bg-gray-900 text-gray-100">
=======
<Layout title={`${bio.display_name || bio.username} - Blähaj.bio`}>
  <div class="min-h-screen flex flex-col bg-github-canvas-default text-github-fg-default">
    <header class="bg-github-canvas-overlay border-b border-github-border-default">
>>>>>>> Stashed changes
      <div class="max-w-7xl mx-auto px-4 py-3">
        <a href="/" class="inline-block text-github-accent-fg hover:text-github-accent-emphasis transition-colors">
          ← Back to Blähaj.bio
        </a>
      </div>
    </header>

    <main class="flex-grow py-16">
      <div class="max-w-2xl mx-auto px-4">
        <div class="bg-github-canvas-overlay rounded-2xl shadow-xl p-8 border border-github-border-default">
          <div class="text-center mb-8">
            {bio.profile_image && (
              <img 
                src={bio.profile_image} 
                alt={bio.display_name || bio.username}
                class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-github-border-default"
              />
            )}
            <h1 class="text-3xl font-bold text-github-fg-default">{bio.display_name || bio.username}</h1>
            {bio.pronouns && <p class="text-github-fg-muted mt-2">{bio.pronouns}</p>}
          </div>
          
          {bio.bio && (
            <div class="prose max-w-none mb-8 text-github-fg-default">
              <p class="whitespace-pre-wrap">{bio.bio}</p>
            </div>
          )}
          
          {bio.links && (
            <div class="space-y-3">
              {bio.links.split('\n').map(link => {
                const trimmedLink = link.trim();
                if (!trimmedLink) return null;
                try {
                  const url = new URL(trimmedLink);
                  return (
                    <a
                      href={trimmedLink}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block w-full text-center py-3 px-4 rounded-lg bg-github-accent-emphasis hover:bg-github-accent-fg text-white transition-colors"
                    >
                      {url.hostname.replace('www.', '')}
                    </a>
                  );
                } catch {
                  return null;
                }
              })}
            </div>
          )}
        </div>
      </div>
    </main>
  </div>
</Layout>
