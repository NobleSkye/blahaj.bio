---
import { callConvexQuery } from '../lib/convex';

const { username } = Astro.params;

if (!username) {
  return Astro.redirect('/404');
}

// Don't redirect specific pages that should not be treated as usernames
const protectedRoutes = ['debug', 'admin', 'api', 'login', 'register', 'dashboard', 'about', 'privacy', 'new', 'settings'];
if (protectedRoutes.includes(username.toLowerCase())) {
  return Astro.redirect('/404');
}

// Check if this username exists in the database before redirecting
let bio;
try {
  bio = await callConvexQuery('bios:getBio', { username: username.toLowerCase() });
} catch (error) {
  console.error('Error checking bio existence:', error);
  return Astro.redirect('/404');
}

if (bio) {
  // Redirect to the @ version if bio exists
  return Astro.redirect(`/@${username}`);
} else {
  // No bio found, go to 404
  return Astro.redirect('/404');
}
---